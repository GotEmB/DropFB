// Generated by CoffeeScript 1.6.3
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

require.config({
  paths: {
    jquery: "jquery/jquery-2.0.3.min",
    batman: "batmanjs/batman",
    bootstrap: "twitter/bootstrap.min",
    facebook: "//connect.facebook.net/en_US/all",
    dropbox: "//dropbox.com/static/api/1/dropins",
    socket_io: "socket.io/socket.io"
  },
  shim: {
    batman: {
      deps: ["jquery"],
      exports: "Batman"
    },
    bootstrap: {
      deps: ["jquery"]
    },
    facebook: {
      exports: "FB"
    },
    dropbox: {
      exports: "Dropbox"
    },
    socket_io: {
      exports: "io"
    }
  }
});

define("Batman", ["batman"], function(Batman) {
  return Batman.DOM.readers.batmantarget = Batman.DOM.readers.target && delete Batman.DOM.readers.target && Batman;
});

require(["jquery", "Batman", "facebook", "dropbox", "socket_io", "bootstrap"], function($, Batman, FB, Dropbox, io) {
  var AppContext, DropFB, Task, User, _ref, _ref1, _ref2;
  User = (function(_super) {
    __extends(User, _super);

    function User() {
      _ref = User.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    return User;

  })(Batman.Model);
  Task = (function(_super) {
    __extends(Task, _super);

    function Task() {
      _ref1 = Task.__super__.constructor.apply(this, arguments);
      return _ref1;
    }

    return Task;

  })(Batman.Model);
  AppContext = (function(_super) {
    __extends(AppContext, _super);

    AppContext.accessor("userLoggedIn", function() {
      return this.get("currentUser") instanceof User;
    });

    function AppContext() {
      var socket,
        _this = this;
      this.set("pageLoading", "true");
      socket = void 0;
      FB.init({
        appId: "364692580326195",
        status: true
      });
      Dropbox.appKey = "wy7kcrp5mm8debj";
      FB.Event.subscribe("auth.authResponseChange", this.fbLoginStatusChanged = function(_arg) {
        var fbAuthResponse, fbStatus;
        fbStatus = _arg.status, fbAuthResponse = _arg.authResponse;
        if (_this.fbLoginStatusChanged.inProgress != null) {
          return;
        }
        _this.fbLoginStatusChanged.inProgress = true;
        if (fbStatus === "connected" && _this.get("userLoggedIn")) {
          return;
        }
        if (fbStatus === "connected" && (fbAuthResponse != null)) {
          return FB.api("/me", function(response2) {
            socket = io.connect();
            return socket.on("connect", function() {
              return socket.emit("handshake", {
                userId: _this.get("userId")
              }, function(_arg1) {
                var tasks;
                tasks = _arg1.tasks;
                _this.set("currentUser", new User({
                  name: response2.name,
                  userId: fbAuthResponse.userID
                }));
                _this.set("tasks", new Batman.Set);
                _this.set("pageLoading", false);
                return delete _this.fbLoginStatusChanged.inProgress;
              });
            });
          });
        } else {
          _this.unset("currentUser");
          if (socket != null) {
            socket.disconnect();
          }
          _this.set("pageLoading", false);
          return delete _this.fbLoginStatusChanged.inProgress;
        }
      });
      FB.getLoginStatus(this.fbLoginStatusChanged);
    }

    AppContext.prototype.fbLogin = function() {
      return FB.login();
    };

    AppContext.prototype.dbChooseFiles = function() {
      var _this = this;
      return Dropbox.choose({
        linkType: "direct",
        multiselect: true,
        success: function(files) {
          var file, _i, _len, _results;
          _results = [];
          for (_i = 0, _len = files.length; _i < _len; _i++) {
            file = files[_i];
            if ((file.thumbnails != null) && file.bytes < 1 << 30 && (_this.get("tasks").find(function(x) {
              return x.path === file.link;
            }) == null)) {
              _results.push(_this.get("tasks").add(new Task({
                path: file.link,
                thumbnail: file.thumbnails["640x480"]
              })));
            }
          }
          return _results;
        }
      });
    };

    return AppContext;

  })(Batman.Model);
  DropFB = (function(_super) {
    __extends(DropFB, _super);

    function DropFB() {
      _ref2 = DropFB.__super__.constructor.apply(this, arguments);
      return _ref2;
    }

    DropFB.appContext = new AppContext;

    return DropFB;

  })(Batman.App);
  DropFB.run();
  return $(function() {
    return $("#navbar2").affix({
      offset: {
        top: 75
      }
    });
  });
});

/*
//@ sourceMappingURL=page.map
*/
